<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    {% include 'sidebar.html' %}
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        {% include 'navbar.html' %}
   
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Exam Management</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#examModal">
                    <i class='bx bx-plus'></i> Create New Exam
                </button>
            </div>

            <!-- Layout row: table + alert distribution -->
            <div class="row">
                <div class="col-lg-8">
                    <!-- Exams Table -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <table id="examsTable" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Exam Title</th>
                                        <th>Subject</th>
                                        <th>Section</th>
                                        <th>Participants</th>
                                        <th>Duration</th>
                                        <th>Questions</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ALERT DISTRIBUTION PANEL -->
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header fw-bold">
                            Alert Distribution
                        </div>
                        <div class="list-group list-group-flush" id="alert-distribution">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Twofaces</span>
                                <span class="badge bg-primary" id="alert-twofaces">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Loud Sound</span>
                                <span class="badge bg-primary" id="alert-loud-sound">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Phone</span>
                                <span class="badge bg-primary" id="alert-phone">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Fullscreen Exit</span>
                                <span class="badge bg-primary" id="alert-fullscreen-exit">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Keyboard Shortcut</span>
                                <span class="badge bg-primary" id="alert-keyboard-shortcut">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Right Click</span>
                                <span class="badge bg-primary" id="alert-right-click">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Tab Switch</span>
                                <span class="badge bg-primary" id="alert-tab-switch">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Captions</span>
                                <span class="badge bg-primary" id="alert-captions">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Face Absent</span>
                                <span class="badge bg-primary" id="alert-face-absent">0</span>
                            </div>
                        </div>

                        <!-- Chart under the badges -->
                        <div class="p-3">
                            <canvas id="alertsChart" height="220"></canvas>
                        </div>
                    </div>
                </div>
                <!-- END ALERT DISTRIBUTION PANEL -->
            </div>
        </div>
    </div>

    <!-- Exam Modal -->
    <div class="modal fade" id="examModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create/Edit Exam</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="examForm">
                        <input type="hidden" id="examId">
                        <div class="mb-3">
                            <label class="form-label">Exam Title</label>
                            <input type="text" class="form-control" id="examTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="examSubject" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="examDuration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date & Time</label>
                            <input type="datetime-local" class="form-control" id="examStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date & Time</label>
                            <input type="datetime-local" class="form-control" id="examEndDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class (Course & Section)</label>
                            <select class="form-control" id="examClassSelect" required>
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>

                        <!-- Dynamic Questions Section -->
                        <div class="mb-3">
                            <label class="form-label">Questions</label>
                            <div id="questionsContainer">
                                <!-- Questions will be added here dynamically -->
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2" id="addQuestion">
                                <i class='bx bx-plus'></i> Add Question
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveExam">Save Exam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS libs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom logic -->
    <script>
        // Toggle Sidebar
        document.getElementById('menu-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
            document.getElementById('main-content').classList.toggle('main-content-expanded');
        });

        // Initialize DataTable
        let examTable = $('#examsTable').DataTable();

        // Question Template
        function getQuestionTemplate(index) {
            return `
                <div class="card mb-2 question-item">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <h6>Question ${index + 1}</h6>
                            <button type="button" class="btn btn-danger btn-sm remove-question">
                                <i class='bx bx-trash'></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control question-text" placeholder="Enter question" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control correct-answer" placeholder="Correct answer" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control wrong-answer" placeholder="Wrong answer 1" required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control wrong-answer" placeholder="Wrong answer 2" required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control wrong-answer" placeholder="Wrong answer 3" required>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add / remove question handlers
        $('#addQuestion').click(function() {
            const questionCount = $('.question-item').length;
            $('#questionsContainer').append(getQuestionTemplate(questionCount));
        });
        $(document).on('click', '.remove-question', function() {
            $(this).closest('.question-item').remove();
            $('.question-item').each((index, item) => {
                $(item).find('h6').text(`Question ${index + 1}`);
            });
        });

        // Load Classes into Select (filtered for proctor)
        async function loadClassesIntoSelect() {
            const userId = sessionStorage.getItem('userId');
            let currentUser = null;
            if (userId) {
                try {
                    const ur = await fetch(`/select?collection=users&id=${encodeURIComponent(userId)}`);
                    if (ur.ok) currentUser = await ur.json();
                } catch (err) {
                    console.error('Failed to load current user', err);
                }
            }

            const response = await fetch('/select?collection=classes');
            let classes = await response.json() || [];

            const role = ((currentUser && (currentUser.role || currentUser.type)) || '').toString().toLowerCase();
            if (role === 'proctor') {
                classes = classes.filter(c => c.proctor_id === userId);
            }

            const $sel = $('#examClassSelect');
            $sel.empty();
            $sel.append('<option value="">-- Select Class --</option>');
            classes.forEach(cls => {
                $sel.append(`<option value="${cls.id}">${cls.course} - ${cls.section}</option>`);
            });
        }

        // Load Exams (filtered for proctors)
        async function loadExams() {
            const userId = sessionStorage.getItem('userId');
            let currentUser = null;
            if (userId) {
                try {
                    const ur = await fetch(`/select?collection=users&id=${encodeURIComponent(userId)}`);
                    if (ur.ok) currentUser = await ur.json();
                } catch (err) {
                    console.error('Failed to load current user', err);
                }
            }

            const [examsResponse, classesResponse, resultsResponse] = await Promise.all([
                fetch('/select?collection=exams'),
                fetch('/select?collection=classes'),
                fetch('/select?collection=exam_results')
            ]);

            let exams = await examsResponse.json() || [];
            const classes = await classesResponse.json() || [];
            const examResults = await resultsResponse.json() || [];

            const classMap = {};
            classes.forEach(cls => classMap[cls.id] = cls);

            const role = ((currentUser && (currentUser.role || currentUser.type)) || '').toString().toLowerCase();
            if (role === 'proctor') {
                exams = exams.filter(e => (e.proctor_id && e.proctor_id === userId) || (e.created_by && e.created_by === userId));
            }

            examTable.clear();
            exams.forEach(exam => {
                // Get section
                let section = 'N/A';
                if (exam.class_id && classMap[exam.class_id]) {
                    const cls = classMap[exam.class_id];
                    section = `${cls.course} - ${cls.section}`;
                }

                // Get participants count
                const participants = examResults.filter(r => r.exam_id === exam.id).length;

                examTable.row.add([
                    `<span class="exam-title-link" data-exam-id="${exam.id}" style="cursor:pointer; text-decoration:underline;">
                        ${exam.title}
                      </span>`,
                    exam.subject,
                    section,
                    participants,
                    `${exam.duration} mins`,
                    (exam.questions || []).length,
                    `<button onclick="editExam('${exam.id}')" class="btn btn-sm btn-warning me-1">
                        <i class='bx bx-edit'></i>
                      </button>
                      <button onclick="copyExam('${exam.id}')" class="btn btn-sm btn-info me-1">
                        <i class='bx bx-copy'></i>
                      </button>
                      <button onclick="deleteExam('${exam.id}')" class="btn btn-sm btn-danger">
                        <i class='bx bx-trash'></i>
                      </button>`
                ]);
            });
            examTable.draw();
        }

        // Which exam we're monitoring alerts for
        let currentMonitoredExamId = null;

        // Click on title to focus alert distribution on that exam
        $('#examsTable tbody').on('click', 'span.exam-title-link', function () {
            const examId = $(this).data('exam-id');
            currentMonitoredExamId = examId;
            console.log('Monitoring alerts for exam:', examId);
            refreshAlertDistribution(); // refresh immediately
        });

        // Save Exam
        $('#saveExam').click(async function() {
            const userId = sessionStorage.getItem('userId') || null;
            const examData = {
                title: $('#examTitle').val(),
                subject: $('#examSubject').val(),
                duration: parseInt($('#examDuration').val()),
                start_date: $('#examStartDate').val(),
                end_date: $('#examEndDate').val(),
                class_id: $('#examClassSelect').val(),
                questions: []
            };

            $('.question-item').each(function() {
                const question = {
                    text: $(this).find('.question-text').val(),
                    correctAnswer: $(this).find('.correct-answer').val(),
                    wrongAnswers: []
                };
                $(this).find('.wrong-answer').each(function() {
                    if ($(this).val()) {
                        question.wrongAnswers.push($(this).val());
                    }
                });
                examData.questions.push(question);
            });

            if (userId) examData.created_by = userId;

            const examId = $('#examId').val();
            const url = examId
                ? `/edit/${examId}?collection=exams`
                : '/add?collection=exams';

            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(examData)
            });

            if (response.ok) {
                $('#examModal').modal('hide');
                loadExams();
            }
        });

        // Edit Exam
        async function editExam(id) {
            const response = await fetch(`/select?collection=exams&id=${id}`);
            const exam = await response.json();

            $('#examId').val(id);
            $('#examTitle').val(exam.title);
            $('#examSubject').val(exam.subject);
            $('#examDuration').val(exam.duration);

            // Set deadline fields
            if (exam.start_date) {
                $('#examStartDate').val(new Date(exam.start_date).toISOString().slice(0, 16));
            }
            if (exam.end_date) {
                $('#examEndDate').val(new Date(exam.end_date).toISOString().slice(0, 16));
            }

            // Load classes and set selected
            await loadClassesIntoSelect();
            $('#examClassSelect').val(exam.class_id || '');

            $('#questionsContainer').empty();
            (exam.questions || []).forEach((question, index) => {
                $('#questionsContainer').append(getQuestionTemplate(index));
                const $questionItem = $('.question-item').last();
                $questionItem.find('.question-text').val(question.text);
                $questionItem.find('.correct-answer').val(question.correctAnswer);
                (question.wrongAnswers || []).forEach((answer, i) => {
                    $questionItem.find('.wrong-answer').eq(i).val(answer);
                });
            });

            $('#examModal').modal('show');
        }

        // Copy Exam
        async function copyExam(id) {
            const response = await fetch(`/select?collection=exams&id=${id}`);
            const exam = await response.json();

            // Clear examId to create a new exam
            $('#examId').val('');
            $('#examTitle').val(exam.title + ' (Copy)');
            $('#examSubject').val(exam.subject);
            $('#examDuration').val(exam.duration);

            // Set deadline fields (can be adjusted)
            if (exam.start_date) {
                $('#examStartDate').val(new Date(exam.start_date).toISOString().slice(0, 16));
            }
            if (exam.end_date) {
                $('#examEndDate').val(new Date(exam.end_date).toISOString().slice(0, 16));
            }

            // Load classes but don't set selected (user can choose)
            await loadClassesIntoSelect();
            $('#examClassSelect').val('');

            $('#questionsContainer').empty();
            (exam.questions || []).forEach((question, index) => {
                $('#questionsContainer').append(getQuestionTemplate(index));
                const $questionItem = $('.question-item').last();
                $questionItem.find('.question-text').val(question.text);
                $questionItem.find('.correct-answer').val(question.correctAnswer);
                (question.wrongAnswers || []).forEach((answer, i) => {
                    $questionItem.find('.wrong-answer').eq(i).val(answer);
                });
            });

            $('#examModal').modal('show');
        }

        // Delete Exam
        async function deleteExam(id) {
            if (!confirm('Are you sure you want to delete this exam?')) return;

            const response = await fetch(`/delete/${id}?collection=exams`, {
                method: 'POST'
            });

            if (response.ok) {
                loadExams();
            }
        }

        // Clear form when modal is hidden
        $('#examModal').on('hidden.bs.modal', function() {
            $('#examForm')[0].reset();
            $('#examId').val('');
            $('#questionsContainer').empty();
            $('#examClassSelect').empty().append('<option value="">-- Select Class --</option>');
        });

        // Load user name
        async function loadUserName() {
            const userId = sessionStorage.getItem('userId');
            if (!userId) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch(`/select?collection=users&id=${userId}`);
                const user = await response.json();
                document.getElementById('userName').textContent = user.name;
            } catch (err) {
                console.error('Error loading user:', err);
            }
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    sessionStorage.removeItem('userId');
                    window.location.href = '/';
                }
            } catch (err) {
                console.error('Error during logout:', err);
            }
        });

        loadExams();
        loadUserName();

        // Show modal -> refresh class list
        $('#examModal').on('show.bs.modal', function() {
            loadClassesIntoSelect();
        });

        /* =======================
           REAL-TIME ALERT DISTRIBUTION + CHART
           ======================= */

        let alertsChart = null;

        function createOrUpdateAlertsChart(counts) {
            const ctx = document.getElementById('alertsChart');
            if (!ctx) return;

            const labels = [
                'Twofaces',
                'Loud Sound',
                'Phone',
                'Fullscreen Exit',
                'Keyboard Shortcut',
                'Right Click',
                'Tab Switch',
                'Captions',
                'Face Absent'
            ];

            const dataArray = [
                counts.twofaces,
                counts.loud_sound,
                counts.phone,
                counts.fullscreen_exit,
                counts.keyboard_shortcut,
                counts.right_click,
                counts.tab_switch,
                counts.captions,
                counts.face_absent
            ];

            if (!alertsChart) {
                alertsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Alert Count',
                            data: dataArray
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });
            } else {
                alertsChart.data.datasets[0].data = dataArray;
                alertsChart.update();
            }
        }

        async function refreshAlertDistribution() {
            try {
                const res = await fetch('/select?collection=proctoring_sessions');
                let sessions = await res.json() || [];

                if (!Array.isArray(sessions) || sessions.length === 0) {
                    return;
                }

                // If a specific exam is selected, filter sessions to that exam
                if (currentMonitoredExamId) {
                    sessions = sessions.filter(s => s.exam_id === currentMonitoredExamId);
                }

                // Prefer active session, else latest by start_time
                let session = null;
                const active = sessions.filter(s => s.status === 'active');
                if (active.length > 0) {
                    active.sort((a, b) => new Date(b.start_time || 0) - new Date(a.start_time || 0));
                    session = active[0];
                } else {
                    sessions.sort((a, b) => new Date(b.start_time || 0) - new Date(a.start_time || 0));
                    session = sessions[0];
                }
                if (!session) return;

                const flags = session.flags || {};
                const count = (name) => Array.isArray(flags[name]) ? flags[name].length : 0;

                const counts = {
                    twofaces: count('twofaces'),
                    loud_sound: count('loud_sound'),
                    phone: count('phone'),
                    fullscreen_exit: count('fullscreen_exit'),
                    keyboard_shortcut: count('keyboard_shortcut'),
                    right_click: count('right_click'),
                    tab_switch: count('tab_switch'),
                    captions: count('captions'),
                    face_absent: count('face_absent')
                };

                // Update badges
                document.getElementById('alert-twofaces').innerText          = counts.twofaces;
                document.getElementById('alert-loud-sound').innerText        = counts.loud_sound;
                document.getElementById('alert-phone').innerText             = counts.phone;
                document.getElementById('alert-fullscreen-exit').innerText   = counts.fullscreen_exit;
                document.getElementById('alert-keyboard-shortcut').innerText = counts.keyboard_shortcut;
                document.getElementById('alert-right-click').innerText       = counts.right_click;
                document.getElementById('alert-tab-switch').innerText        = counts.tab_switch;
                document.getElementById('alert-captions').innerText          = counts.captions;
                document.getElementById('alert-face-absent').innerText       = counts.face_absent;

                // Update chart
                createOrUpdateAlertsChart(counts);

            } catch (err) {
                console.error('Failed to refresh alert distribution:', err);
            }
        }

        // First load + auto-refresh every 5 seconds
        refreshAlertDistribution();
        setInterval(refreshAlertDistribution, 5000);
    </script>
</body>
</html>
