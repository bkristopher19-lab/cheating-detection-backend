<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        .exam-card {
            transition: transform 0.2s;
        }
        .exam-card:hover {
            transform: translateY(-5px);
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-mode .navbar {
            background-color: #1e1e1e !important;
            border-bottom: 1px solid #333;
        }

        body.dark-mode .navbar-brand,
        body.dark-mode .navbar-text,
        body.dark-mode .nav-link {
            color: #ffffff !important;
        }

        body.dark-mode .card {
            background-color: #1e1e1e;
            border-color: #333;
            color: #ffffff;
        }

        body.dark-mode .modal-content {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        body.dark-mode .modal-header,
        body.dark-mode .modal-footer {
            border-color: #333;
        }

        body.dark-mode .dropdown-menu {
            background-color: #1e1e1e;
            border-color: #333;
        }

        body.dark-mode .dropdown-item {
            color: #ffffff;
        }

        body.dark-mode .dropdown-item:hover {
            background-color: #333;
        }

        body.dark-mode .alert {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="#">Online Proctoring System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-3">
                        <span class="navbar-text" id="userInfo">
                            <strong id="userName"></strong><br>
                            <small id="userEmail"></small><br>
                            <small class="text-muted" id="userSection" style="font-size: 0.85rem;">
                                <i class='bx bx-group'></i> <span id="sectionDisplay">Loading section...</span>
                            </small>
                        </span>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class='bx bx-menu'></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="profileBtn">
                                <i class='bx bx-user'></i> Profile
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="darkModeBtn">
                                <i class='bx bx-moon'></i> <span id="darkModeText">Dark Mode</span>
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">
                                <i class='bx bx-log-out'></i> Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Join class by code -->
        <div class="card mb-4">
            <div class="card-body d-flex flex-column flex-md-row align-items-md-center gap-3">
                <div>
                    <h5 class="mb-1">Join a Section with Code</h5>
                    <p class="mb-0 text-muted small">Enter the join code shared by your proctor/admin to link to a section.</p>
                </div>
                <div class="ms-md-auto d-flex gap-2 w-100 w-md-auto">
                    <input type="text" id="joinCodeInput" class="form-control" placeholder="e.g., ABC123" maxlength="10" style="text-transform: uppercase;">
                    <button class="btn btn-primary" id="joinCodeBtn">Join</button>
                </div>
                <div id="joinCodeMessage" class="small"></div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Available Exams</h2>
            <div class="alert alert-info mb-0" style="padding: 0.5rem 1rem;">
                <small><i class='bx bx-info-circle'></i> Showing exams for your section only</small>
            </div>
        </div>

        <div class="row" id="examsList">
            <!-- Exams will be loaded here dynamically -->
        </div>

        <!-- Student Scores Section -->
        <div class="mt-5">
            <h2 class="mb-4">My Exam Scores</h2>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Exam Type</th>
                                    <th>Score</th>
                                    <th>Date Taken</th>
                                </tr>
                            </thead>
                            <tbody id="scoresTable">
                                <!-- Scores will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Proctoring Consent Modal -->
    <div class="modal fade" id="proctoringModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exam Monitoring Consent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6>Before proceeding with the exam, please note:</h6>
                        <ul>
                            <li>Your webcam will be used to monitor the exam session</li>
                            <li>Audio may be recorded during the exam</li>
                            <li>Screen recording may be enabled</li>
                            <li>All monitoring data will be automatically deleted after 14 days</li>
                            <li>The data will only be used for exam integrity verification</li>
                        </ul>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="consentCheck">
                        <label class="form-check-label" for="consentCheck">
                            I understand and agree to exam monitoring
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="startExamBtn" disabled>Start Exam</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedExamId = null;

        // Load available exams (filtered by student's section)
        async function loadExams() {
            const userId = sessionStorage.getItem('userId');
            if (!userId) return;

            // Load user, classes, exams, and proctoring sessions in parallel
            const [userResponse, classesResponse, examsResponse, sessionsResponse] = await Promise.all([
                fetch('/select?collection=users&id=' + userId),
                fetch('/select?collection=classes'),
                fetch('/select?collection=exams'),
                fetch('/select?collection=proctoring_sessions')
            ]);

            if (!userResponse.ok || !classesResponse.ok || !examsResponse.ok || !sessionsResponse.ok) {
                console.error('Failed to load user, classes, exams, or sessions');
                return;
            }

            const user = await userResponse.json();
            const classes = await classesResponse.json();
            const allExams = await examsResponse.json();
            const allSessions = await sessionsResponse.json();

            // Get student's class_id
            const studentClassId = user.class_id;
            
            // Build class lookup
            const classMap = {};
            classes.forEach(cls => classMap[cls.id] = cls);

            // Display student's section
            if (studentClassId && classMap[studentClassId]) {
                const studentClass = classMap[studentClassId];
                document.getElementById('sectionDisplay').textContent = `${studentClass.course} - ${studentClass.section}`;
            } else {
                document.getElementById('sectionDisplay').textContent = 'Not assigned';
                document.getElementById('sectionDisplay').style.color = '#dc3545';
            }

            // Filter exams to only show exams for student's section
            const exams = studentClassId 
                ? allExams.filter(exam => exam.class_id === studentClassId)
                : []; // If student has no class_id, show no exams

            const examsList = document.getElementById('examsList');
            examsList.innerHTML = '';

            if (exams.length === 0 && !studentClassId) {
                examsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class='bx bx-info-circle'></i> You are not assigned to any section. Please contact your administrator or join with a code below.
                        </div>
                    </div>
                `;
                return;
            }

            if (exams.length === 0) {
                examsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class='bx bx-info-circle'></i> No exams available for your section at this time.
                        </div>
                    </div>
                `;
                return;
            }

            // Build a quick lookup for prior violation info per exam for this user
            const violationInfoByExam = {};
            const userSessions = (allSessions || []).filter(s =>
                s &&
                (s.student_id === user.id || s.user_id === user.id) &&
                s.exam_id
            );

            userSessions.forEach(s => {
                const examId = s.exam_id;
                if (!examId) return;
                const flags = s.flags || {};
                const hasPhone =
                    (flags.phone && flags.phone.length > 0) ||
                    (flags.object_detected_cell_phone && flags.object_detected_cell_phone.length > 0);
                const terminated = (s.status && s.status.toString().toLowerCase() === 'terminated');

                if (!violationInfoByExam[examId]) {
                    violationInfoByExam[examId] = {
                        hasPhone: false,
                        terminated: false
                    };
                }

                violationInfoByExam[examId].hasPhone =
                    violationInfoByExam[examId].hasPhone || hasPhone;
                violationInfoByExam[examId].terminated =
                    violationInfoByExam[examId].terminated || terminated;
            });

            const now = new Date();

            exams.forEach(exam => {
                // Check if user has already taken this exam
                const taken = user.exams_taken && user.exams_taken.includes(exam.id);

                // Check deadline
                let deadlineStatus = 'available';
                let deadlineText = '';
                if (exam.start_date && exam.end_date) {
                    const startDate = new Date(exam.start_date);
                    const endDate = new Date(exam.end_date);

                    if (now < startDate) {
                        deadlineStatus = 'not-started';
                        deadlineText = `Starts: ${startDate.toLocaleString()}`;
                    } else if (now > endDate) {
                        deadlineStatus = 'expired';
                        deadlineText = `Ended: ${endDate.toLocaleString()}`;
                    } else {
                        deadlineText = `Ends: ${endDate.toLocaleString()}`;
                    }
                }

                const vInfo = violationInfoByExam[exam.id];
                const blockedForViolations = vInfo && (vInfo.terminated || vInfo.hasPhone);

                let buttonHtml = '';
                let violationNoteHtml = '';
                if (taken) {
                    buttonHtml = '<button class="btn btn-secondary" disabled>Completed</button>';
                } else if (blockedForViolations) {
                    buttonHtml = '<button class="btn btn-danger" disabled>Blocked (prior violations)</button>';
                    if (vInfo && vInfo.hasPhone) {
                        violationNoteHtml = '<p class="card-text small text-danger mb-0">Previous attempt blocked: phone detected.</p>';
                    } else if (vInfo && vInfo.terminated) {
                        violationNoteHtml = '<p class="card-text small text-danger mb-0">Previous attempt terminated due to violations.</p>';
                    }
                } else if (deadlineStatus === 'not-started') {
                    buttonHtml = '<button class="btn btn-warning" disabled>Not Started</button>';
                } else if (deadlineStatus === 'expired') {
                    buttonHtml = '<button class="btn btn-danger" disabled>Expired</button>';
                } else {
                    buttonHtml = `<button class="btn btn-primary" onclick="showProctoring('${exam.id}')">Take Exam</button>`;
                }

                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card exam-card">
                            <div class="card-body">
                                <h5 class="card-title">${exam.title}</h5>
                                <p class="card-text">${exam.subject}</p>
                                <p class="card-text">Duration: ${exam.duration} minutes</p>
                                <p class="card-text">Questions: ${exam.questions.length}</p>
                                <p class="card-text small text-muted">${deadlineText}</p>
                                ${violationNoteHtml}
                                ${buttonHtml}
                            </div>
                        </div>
                    </div>
                `;
                examsList.innerHTML += card;
            });
        }

        // Show proctoring consent modal
        function showProctoring(examId) {
            selectedExamId = examId;
            const modal = new bootstrap.Modal(document.getElementById('proctoringModal'));
            modal.show();
        }

        // Handle consent checkbox
        document.getElementById('consentCheck').addEventListener('change', function() {
            document.getElementById('startExamBtn').disabled = !this.checked;
        });

        // Handle exam start
        document.getElementById('startExamBtn').addEventListener('click', function() {
            if (selectedExamId) {
                const userId = sessionStorage.getItem('userId');
                window.location.href = `/take_exam/${selectedExamId}?user_id=${userId}`;
            }
        });

        // Join class by code
        document.getElementById('joinCodeBtn').addEventListener('click', async function() {
            const codeInput = document.getElementById('joinCodeInput');
            const msgEl = document.getElementById('joinCodeMessage');
            msgEl.textContent = '';
            msgEl.className = 'small';

            const rawCode = (codeInput.value || '').trim().toUpperCase();
            if (!rawCode) {
                msgEl.textContent = 'Please enter a join code.';
                msgEl.classList.add('text-danger');
                return;
            }

            try {
                // Load classes and find by join_code (case-insensitive match)
                const classesResponse = await fetch('/select?collection=classes');
                const classes = await classesResponse.json();
                const targetClass = classes.find(cls => (cls.join_code || '').toUpperCase() === rawCode);

                if (!targetClass) {
                    msgEl.textContent = 'Invalid join code.';
                    msgEl.classList.add('text-danger');
                    return;
                }

                // Update user with class_id
                const userId = sessionStorage.getItem('userId');
                if (!userId) {
                    msgEl.textContent = 'You must be logged in to join a section.';
                    msgEl.classList.add('text-danger');
                    return;
                }

                const updateRes = await fetch(`/edit/${userId}?collection=users`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ class_id: targetClass.id })
                });

                if (!updateRes.ok) {
                    let errText = 'Failed to join section. Please try again.';
                    try {
                        const errJson = await updateRes.json();
                        if (errJson && errJson.error) {
                            errText = `Failed to join section: ${errJson.error}`;
                        }
                    } catch (_) {}
                    msgEl.textContent = errText;
                    msgEl.classList.add('text-danger');
                    return;
                }

                msgEl.textContent = `Joined section: ${targetClass.course} - ${targetClass.section}`;
                msgEl.classList.add('text-success');

                // Refresh UI
                loadExams();
                loadUserInfo();
            } catch (err) {
                console.error('Join code error:', err);
                msgEl.textContent = 'Error joining section. Please try again.';
                msgEl.classList.add('text-danger');
            }
        });

        // Add logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Clear session storage
                    sessionStorage.clear();
                    // Redirect to login page
                    window.location.href = '/';
                } else {
                    alert('Logout failed');
                }
            } catch (err) {
                console.error('Error during logout:', err);
                alert('Error during logout');
            }
        });

        // Check if user is logged in when page loads
        function checkAuth() {
            const userId = sessionStorage.getItem('userId');
            if (!userId) {
                window.location.href = '/';
                return false;
            }

            // Check if user is a student
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            if (user.type !== 'student') {
                window.location.href = '/';
                return false;
            }

            // Load user info
            loadUserInfo();

            return true;
        }

        // Load user information
        async function loadUserInfo() {
            const userId = sessionStorage.getItem('userId');
            const userResponse = await fetch('/select?collection=users&id=' + userId);
            const user = await userResponse.json();
            
            document.getElementById('userName').textContent = user.name || 'Student';
            document.getElementById('userEmail').textContent = user.email || '';

            // Load student's section
            if (user.class_id) {
                const classesResponse = await fetch('/select?collection=classes');
                const classes = await classesResponse.json();
                const studentClass = classes.find(cls => cls.id === user.class_id);
                if (studentClass) {
                    document.getElementById('sectionDisplay').textContent = `${studentClass.course} - ${studentClass.section}`;
                } else {
                    document.getElementById('sectionDisplay').textContent = 'Not assigned';
                }
            } else {
                document.getElementById('sectionDisplay').textContent = 'Not assigned';
                document.getElementById('sectionDisplay').style.color = '#dc3545';
            }

            // Load dark mode preference
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeText').textContent = 'Light Mode';
            }
        }

        // Profile button handler
        document.getElementById('profileBtn').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/profile';
        });

        // Dark mode toggle
        document.getElementById('darkModeBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeText').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        });

        // Load student scores
        async function loadStudentScores() {
            const userId = sessionStorage.getItem('userId');
            const userResponse = await fetch('/select?collection=users&id=' + userId);
            const user = await userResponse.json();

            const tbody = document.getElementById('scoresTable');
            tbody.innerHTML = '';

            if (user.exams_taken && user.exams_taken.length > 0) {
                for (const examId of user.exams_taken) {
                    try {
                        // Get exam details
                        const examResponse = await fetch(`/select?collection=exams&id=${examId}`);
                        const exam = await examResponse.json();

                        // Get exam results to calculate score
                        const resultsResponse = await fetch('/select?collection=exam_results');
                        const allResults = await resultsResponse.json();

                        // Find the result for this user and exam
                        const userResult = allResults.find(result =>
                            result.user_id === userId && result.exam_id === examId
                        );

                        let scoreDisplay = 'N/A';
                        let dateTaken = 'N/A';
                        let statusBadge = '';

                        if (userResult) {
                            // Show forced/terminated as 0
                            if (userResult.forced_score === 0 || userResult.terminated) {
                                scoreDisplay = '0 (terminated)';
                                statusBadge = '<span class="badge bg-danger">Terminated</span>';
                            } else if (exam.questions) {
                                let correctAnswers = 0;
                                exam.questions.forEach((question, index) => {
                                    if (userResult.answers && userResult.answers[index] === question.correctAnswer) {
                                        correctAnswers++;
                                    }
                                });
                                scoreDisplay = `${correctAnswers}/${exam.questions.length}`;
                                statusBadge = '<span class="badge bg-success">Completed</span>';
                            }
                            dateTaken = userResult.timestamp ? new Date(userResult.timestamp).toLocaleDateString() : 'N/A';
                        }

                        const row = `
                            <tr>
                                <td>${user.name || 'Unknown'}</td>
                                <td>${exam.title || 'Unknown'} (${exam.subject || ''})</td>
                                <td>${scoreDisplay} ${statusBadge}</td>
                                <td>${dateTaken}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    } catch (err) {
                        console.warn('Error loading score for exam:', examId, err);
                    }
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No exams taken yet</td></tr>';
            }
        }

        // Load exams when page loads
        loadExams();
        loadStudentScores();
        
        // Refresh exams when page becomes visible (user returns from exam)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page is now visible, refresh exams to show updated completion status
                loadExams();
                loadStudentScores();
            }
        });
        
        // Also refresh on focus (when user switches back to tab)
        window.addEventListener('focus', () => {
            loadExams();
            loadStudentScores();
        });
    </script>
</body>
</html>
