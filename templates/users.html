<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
 
</head>
<body>
    <!-- Include Sidebar -->
    {% include 'sidebar.html' %}
 
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Include Navbar -->
        {% include 'navbar.html' %}

        <!-- Page Content -->
        <div class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">User Management</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
                    <i class='bx bx-plus'></i> Add New User
                </button>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-body">
                    <table id="usersTable" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-control" id="role" required>
                                <option value="student">Student</option>
                                <option value="proctor">Proctor</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveUser">Save User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the same scripts as exams.html -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Initialize DataTable
        let userTable = $('#usersTable').DataTable();
        
        // Load Users
        async function loadUsers() {
            const response = await fetch('/select?collection=users');
            const users = await response.json();
            
            userTable.clear();
            users.forEach(user => {
                userTable.row.add([
                    user.name,
                    user.email,
                    user.role || 'student',
                    `<button onclick="editUser('${user.id}')" class="btn btn-sm btn-warning me-1">
                        <i class='bx bx-edit'></i>
                     </button>
                     <button onclick="deleteUser('${user.id}')" class="btn btn-sm btn-danger">
                        <i class='bx bx-trash'></i>
                     </button>`
                ]);
            });
            userTable.draw();
        }

        // Save User
        $('#saveUser').click(async function() {
            const userData = {
                name: $('#name').val(),
                email: $('#email').val(),
                password: $('#password').val(),
                role: $('#role').val()
            };

            const userId = $('#userId').val();
            const url = userId ? `/edit/${userId}?collection=users` : '/add?collection=users';
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                $('#userModal').modal('hide');
                loadUsers();
            }
        });

        // Edit User
        async function editUser(id) {
            const response = await fetch(`/select?collection=users&id=${id}`);
            const user = await response.json();
            
            $('#userId').val(id);
            $('#name').val(user.name);
            $('#email').val(user.email);
            $('#role').val(user.role || 'student');
            $('#password').val(''); // Don't populate password
            
            $('#userModal').modal('show');
        }

        // Delete User
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const response = await fetch(`/delete/${id}?collection=users`, {
                method: 'POST'
            });
            
            if (response.ok) {
                loadUsers();
            }
        }

        // Clear form when modal is hidden
        $('#userModal').on('hidden.bs.modal', function() {
            $('#userForm')[0].reset();
            $('#userId').val('');
        });

        // Load users on page load
        loadUsers();

        // Toggle Sidebar
        document.getElementById('menu-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
            document.getElementById('main-content').classList.toggle('main-content-expanded');
        });
    </script>
</body>
</html>