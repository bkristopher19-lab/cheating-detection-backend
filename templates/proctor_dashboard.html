<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proctoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        .stat-card {
            border-radius: 15px;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mini-chart {
            height: 300px;
        }
        .alert-type {
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .back-btn-mobile {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            border: 1px solid #dee2e6;
            color: #495057;
            display: none;
        }

        .back-btn-mobile:hover {
            background: #f8f9fa;
            color: #212529;
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 1rem !important;
            }

            .stat-card {
                margin-bottom: 1rem;
            }

            .stat-card .card-body {
                padding: 1rem;
            }

            .stat-card .h3 {
                font-size: 1.5rem;
            }

            .stat-card .text-xs {
                font-size: 0.75rem;
            }

            .stat-card .small {
                font-size: 0.7rem;
            }

            .card-header h6 {
                font-size: 0.9rem;
            }

            .table-responsive {
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 0.5rem;
            }

            .alert-type {
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .badge {
                font-size: 0.7rem;
            }

            /* Stack cards vertically on mobile */
            .row .col-xl-3,
            .row .col-md-6 {
                margin-bottom: 1rem;
            }

            /* Make tables more mobile-friendly */
            .table-responsive {
                border: none;
            }

            .table-responsive .table {
                margin-bottom: 0;
            }

            /* Adjust top lists layout */
            .col-xl-6 {
                margin-bottom: 1rem;
            }

            /* Show back button on mobile */
            .back-btn-mobile {
                display: block !important;
            }
        }

        /* Dark mode support - Optimized for all devices */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-mode .stat-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            color: #ffffff;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.4) !important;
        }

        body.dark-mode .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
        }

        body.dark-mode .stat-card .text-muted {
            color: #cccccc !important;
        }

        body.dark-mode .stat-card .stat-icon {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        body.dark-mode .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            color: #ffffff;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.4) !important;
        }

        body.dark-mode .card-header {
            background-color: #2d2d2d;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        body.dark-mode .card-header h6 {
            color: #ffffff;
        }

        body.dark-mode .table {
            color: #ffffff;
        }

        body.dark-mode .table th {
            background-color: #2d2d2d;
            border-color: #444;
            color: #ffffff;
            font-weight: 600;
        }

        body.dark-mode .table td {
            background-color: #1e1e1e;
            border-color: #333;
            color: #ffffff;
        }

        body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
            background-color: #252525;
        }

        body.dark-mode .table-striped tbody tr:nth-of-type(even) {
            background-color: #1e1e1e;
        }

        body.dark-mode .table-hover tbody tr:hover {
            background-color: #333333;
            color: #ffffff;
        }

        body.dark-mode .alert-type {
            background-color: #2d2d2d !important;
            border: 1px solid #444;
            color: #ffffff;
        }

        body.dark-mode .badge {
            background-color: #6ee7b7 !important;
            color: #032;
            font-weight: 500;
        }

        body.dark-mode .text-uppercase {
            color: #ffffff;
        }

        body.dark-mode h1, body.dark-mode h3, body.dark-mode h4, body.dark-mode h6 {
            color: #ffffff;
        }

        body.dark-mode .text-primary { color: #4dabf7 !important; }
        body.dark-mode .text-success { color: #51cf66 !important; }
        body.dark-mode .text-info { color: #74c0fc !important; }
        body.dark-mode .text-warning { color: #ffd43b !important; }
        body.dark-mode .text-danger { color: #ff6b6b !important; }
        body.dark-mode .text-secondary { color: #868e96 !important; }

        body.dark-mode .bg-primary { background-color: #4dabf7 !important; }
        body.dark-mode .bg-success { background-color: #51cf66 !important; }
        body.dark-mode .bg-info { background-color: #74c0fc !important; }
        body.dark-mode .bg-warning { background-color: #ffd43b !important; }
        body.dark-mode .bg-danger { background-color: #ff6b6b !important; }
        body.dark-mode .bg-secondary { background-color: #868e96 !important; }

        body.dark-mode .border-left-primary { border-left-color: #4dabf7 !important; }
        body.dark-mode .border-left-success { border-left-color: #51cf66 !important; }
        body.dark-mode .border-left-info { border-left-color: #74c0fc !important; }
        body.dark-mode .border-left-warning { border-left-color: #ffd43b !important; }
        body.dark-mode .border-left-danger { border-left-color: #ff6b6b !important; }
        body.dark-mode .border-left-secondary { border-left-color: #868e96 !important; }

        /* Enhanced mobile dark mode */
        @media (max-width: 768px) {
            body.dark-mode {
                background-color: #0d0d0d;
            }

            body.dark-mode .stat-card,
            body.dark-mode .card {
                background-color: #1a1a1a;
                border-color: #404040;
            }

            body.dark-mode .card-header {
                background-color: #262626;
                border-color: #404040;
            }

            body.dark-mode .table th,
            body.dark-mode .table td {
                border-color: #404040;
            }

            body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
                background-color: #202020;
            }

            body.dark-mode .table-striped tbody tr:nth-of-type(even) {
                background-color: #1a1a1a;
            }
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}

    <div class="main-content" id="main-content">
        <button class="btn btn-secondary back-btn-mobile" onclick="window.history.back()"><i class='bx bx-arrow-back'></i> Back</button>
        {% include 'navbar.html' %}

        <div class="container-fluid p-4">
            <h1 class="h3 mb-4">Analytics Dashboard</h1>
            
            <!-- Main Stats -->
            <div class="row">
                <!-- Users Stats -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card card border-left-primary shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-primary fw-bold">Total Students</div>
                                    <div class="h3 mb-0 fw-bold" id="totalStudents">0</div>
                                    <div class="text-muted small">Active Users</div>
                                </div>
                                <div class="stat-icon bg-primary bg-opacity-10">
                                    <i class='bx bxs-graduation text-primary fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exams Stats -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card card border-left-success shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-success fw-bold">Active Exams</div>
                                    <div class="h3 mb-0 fw-bold" id="totalExams">0</div>
                                    <div class="text-muted small">Available Tests</div>
                                </div>
                                <div class="stat-icon bg-success bg-opacity-10">
                                    <i class='bx bxs-book-open text-success fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sessions Stats -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card card border-left-info shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-info fw-bold">Total Sessions</div>
                                    <div class="h3 mb-0 fw-bold" id="totalSessions">0</div>
                                    <div class="text-muted small">Exam Attempts</div>
                                </div>
                                <div class="stat-icon bg-info bg-opacity-10">
                                    <i class='bx bxs-time text-info fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Stats -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card card border-left-warning shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-warning fw-bold">Total Alerts</div>
                                    <div class="h3 mb-0 fw-bold" id="totalAlerts">0</div>
                                    <div class="text-muted small">Detected Issues</div>
                                </div>
                                <div class="stat-icon bg-warning bg-opacity-10">
                                    <i class='bx bxs-bell text-warning fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="row">
                <!-- Alert Types Distribution -->
                <div class="col-xl-4 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold">Alert Distribution</h6>
                        </div>
                        <div class="card-body">
                            <div id="alertTypes">
                                <!-- Alert types will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Exam Scores & Proctoring Flags -->
                <div class="col-xl-8 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold">Student Exam Scores & Proctoring Flags</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Exam Type</th>
                                            <th>Score</th>
                                            <th>Date Taken</th>
                                            <th>Proctoring Flags</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentScoresTable">
                                        <!-- Student scores will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Stats Row -->
            <div class="row mb-4">
                <!-- Teachers Count -->
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card border-left-secondary shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-secondary fw-bold">Teachers</div>
                                    <div class="h3 mb-0 fw-bold" id="totalTeachers">0</div>
                                </div>
                                <div class="stat-icon bg-secondary bg-opacity-10">
                                    <i class='bx bxs-user text-secondary fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Reports Button (Admin Only) -->
                <div class="col-xl-6 col-lg-12 col-md-12 mb-4" id="adminControls" style="display: none;">
                    <div class="stat-card card border-left-danger shadow h-100">
                        <div class="card-body">
                            <div class="text-xs text-uppercase mb-3 text-danger fw-bold">Admin Controls</div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="cutoffDays" class="form-label small">Delete reports older than (days):</label>
                                    <input type="number" class="form-control form-control-sm" id="cutoffDays" value="14" min="1" max="365">
                                </div>
                                <div class="col-md-6">
                                    <label for="cutoffDate" class="form-label small">Or select specific date:</label>
                                    <input type="date" class="form-control form-control-sm" id="cutoffDate">
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-danger btn-sm me-2" id="deleteReportsBtn" onclick="deleteOldReports()">
                                    <i class='bx bx-trash'></i> Delete Old Reports
                                </button>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearDateSelection()">
                                    <i class='bx bx-x'></i> Clear Date
                                </button>
                                <button class="btn btn-danger btn-sm" id="deleteAllBtn" onclick="deleteAllReports()">
                                    <i class='bx bx-trash-alt'></i> Delete ALL Reports
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Average Session Duration -->
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card border-left-danger shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-danger fw-bold">Avg. Duration</div>
                                    <div class="h3 mb-0 fw-bold" id="avgDuration">0 min</div>
                                </div>
                                <div class="stat-icon bg-danger bg-opacity-10">
                                    <i class='bx bxs-timer text-danger fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Questions -->
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card border-left-primary shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-primary fw-bold">Questions</div>
                                    <div class="h3 mb-0 fw-bold" id="totalQuestions">0</div>
                                </div>
                                <div class="stat-icon bg-primary bg-opacity-10">
                                    <i class='bx bxs-help-circle text-primary fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alert Rate -->
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card border-left-warning shadow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-xs text-uppercase mb-1 text-warning fw-bold">Alert Rate</div>
                                    <div class="h3 mb-0 fw-bold" id="alertRate">0%</div>
                                </div>
                                <div class="stat-icon bg-warning bg-opacity-10">
                                    <i class='bx bxs-error text-warning fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Additional Statistics -->
            <div class="row mb-4">
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card shadow h-100">
                        <div class="card-body">
                            <div class="text-xs text-uppercase mb-1 fw-bold">Total Classes</div>
                            <div class="h4 fw-bold" id="totalClasses">0</div>
                            <div class="text-muted small">Course & Section</div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card shadow h-100">
                        <div class="card-body">
                            <div class="text-xs text-uppercase mb-1 fw-bold">Avg Exams per Class</div>
                            <div class="h4 fw-bold" id="avgExamsPerClass">0</div>
                            <div class="text-muted small">Distribution</div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card shadow h-100">
                        <div class="card-body">
                            <div class="text-xs text-uppercase mb-1 fw-bold">Completion Rate</div>
                            <div class="h4 fw-bold" id="completionRate">0%</div>
                            <div class="text-muted small">Sessions Completed</div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <div class="stat-card card shadow h-100">
                        <div class="card-body">
                            <div class="text-xs text-uppercase mb-1 fw-bold">Avg Alerts / Session</div>
                        <div class="h4 fw-bold" id="avgAlertsPerSession">0</div>
                            <div class="text-muted small">Alert density</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Lists -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold">Top 5 Students by Alerts</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Student</th><th>Alerts</th></tr></thead>
                                    <tbody id="topStudentsByAlerts"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold">Top 5 Exams by Alert Rate</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Exam</th><th>Alerts / Session</th></tr></thead>
                                    <tbody id="topExamsByAlertRate"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Get current proctor user ID
                const userId = sessionStorage.getItem('userId');
                if (!userId) {
                    console.error('No user ID found');
                    return;
                }

                // Fetch all required data (include classes)
                const [users, exams, sessions, classes, examResults] = await Promise.all([
                    fetch('/select?collection=users').then(r => r.json()),
                    fetch('/select?collection=exams').then(r => r.json()),
                    fetch('/select?collection=proctoring_sessions').then(r => r.json()),
                    fetch('/select?collection=classes').then(r => r.json()),
                    fetch('/select?collection=exam_results').then(r => r.json())
                ]);

                // Check if proctor has classes assigned
                const proctorClasses = (classes || []).filter(c => c.proctor_id === userId);
                const proctorClassIds = proctorClasses.map(c => c.id);

                // If proctor has classes, filter by classes; otherwise show all exams
                let proctorExams, proctorExamIds;
                if (proctorClassIds.length > 0) {
                    // Filter exams to those in proctor's classes
                    proctorExams = (exams || []).filter(e => proctorClassIds.includes(e.class_id));
                    proctorExamIds = proctorExams.map(e => e.id);
                } else {
                    // If no classes assigned, show all exams (admin/proctor can see all)
                    proctorExams = exams || [];
                    proctorExamIds = proctorExams.map(e => e.id);
                }

                // Filter sessions to those for proctor's exams
                const proctorSessions = (sessions || []).filter(s => proctorExamIds.includes(s.exam_id));

                // Filter exam results to those for proctor's exams
                const proctorExamResults = (examResults || []).filter(r => proctorExamIds.includes(r.exam_id));

                // Use filtered data
                const filteredUsers = users;
                const filteredExams = proctorExams;
                const filteredSessions = proctorSessions;
                const filteredClasses = proctorClasses;
                const filteredExamResults = proctorExamResults;

                // Normalize role/type accessor
                const userRole = u => ((u.role || u.type || '')).toString().toLowerCase();

                // Students: prefer explicit user records, otherwise infer from results/sessions
                let studentUsers = users.filter(u => userRole(u) === 'student');
                if (studentUsers.length === 0) {
                    // fallback: unique user ids from exam_results and sessions
                    const idsFromResults = (examResults || []).map(r => r.user_id).filter(Boolean);
                    const idsFromSessions = (sessions || []).map(s => s.user_id).filter(Boolean);
                    const uniqueIds = Array.from(new Set([...idsFromResults, ...idsFromSessions]));
                    studentUsers = uniqueIds.map(id => users.find(u => u.id === id)).filter(Boolean);
                }

                // Proctors: combine explicit proctor users and any proctor_id referenced in classes
                const proctorUsers = users.filter(u => userRole(u) === 'proctor');
                const proctorIdsFromClasses = Array.from(new Set((classes || []).map(c => c.proctor_id).filter(Boolean)));
                const combinedProctorIds = new Set(proctorUsers.map(p => p.id).concat(proctorIdsFromClasses));
                const teachersCount = combinedProctorIds.size;

                // Alerts aggregation - using same types as reports page
                let totalAlerts = 0;
                let alertTypes = {
                    twofaces: 0,
                    loud_sound: 0,
                    phone: 0,
                    fullscreen_exit: 0,
                    keyboard_shortcut: 0,
                    right_click: 0,
                    tab_switch: 0
                };
                (sessions || []).forEach(session => {
                    if (session.flags) {
                        Object.entries(session.flags).forEach(([type, alerts]) => {
                            if (Array.isArray(alerts)) {
                                alertTypes[type] = (alertTypes[type] || 0) + alerts.length;
                                totalAlerts += alerts.length;
                            }
                        });
                    }
                });

                // Total questions (defensive)
                const totalQuestions = (exams || []).reduce((sum, exam) => {
                    const qlen = Array.isArray(exam.questions) ? exam.questions.length : 0;
                    return sum + qlen;
                }, 0);

                // Avg session duration (defensive)
                const durations = (sessions || []).map(s => {
                    const start = new Date(s.start_time);
                    const end = new Date(s.end_time);
                    if (isNaN(start) || isNaN(end)) return 0;
                    return (end - start) / (1000 * 60); // minutes
                }).filter(d => d > 0);
                const avgDuration = durations.length ? Math.round(durations.reduce((a, b) => a + b) / durations.length) : 0;

                // Update UI
                document.getElementById('totalStudents').textContent = studentUsers.length;
                document.getElementById('totalTeachers').textContent = teachersCount;
                document.getElementById('totalExams').textContent = (exams || []).length;
                document.getElementById('totalSessions').textContent = (sessions || []).length;
                document.getElementById('totalAlerts').textContent = totalAlerts;
                document.getElementById('totalQuestions').textContent = totalQuestions;
                document.getElementById('avgDuration').textContent = `${avgDuration} min`;
                document.getElementById('alertRate').textContent = `${Math.round(totalAlerts / Math.max(1, (sessions || []).length))} per exam`;

                // Update alert types distribution
                const alertTypesHtml = Object.entries(alertTypes)
                    .map(([type, count]) => `
                        <div class="alert-type bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-capitalize">${type.replace(/_/g, ' ')}</span>
                                <span class="badge bg-primary">${count}</span>
                            </div>
                        </div>
                    `).join('');
                document.getElementById('alertTypes').innerHTML = alertTypesHtml || '<div class="text-muted">No alerts detected</div>';



                // --- NEW metrics calculations ---

                // Total classes
                const totalClasses = (classes || []).length;
                document.getElementById('totalClasses').textContent = totalClasses;

                // Avg exams per class (map by class.course+section or count exams with exam.class_id if present)
                // fallback: exams / classes
                const avgExamsPerClass = totalClasses ? ((exams || []).length / totalClasses) : 0;
                document.getElementById('avgExamsPerClass').textContent = avgExamsPerClass.toFixed(2);

                // Completion rate: sessions with status === 'completed'
                const completed = (sessions || []).filter(s => (s.status || '').toString().toLowerCase() === 'completed').length;
                const completionRate = (sessions && sessions.length) ? Math.round((completed / sessions.length) * 100) : 0;
                document.getElementById('completionRate').textContent = `${completionRate}%`;

                // Avg alerts per session
                const avgAlertsPerSession = sessions && sessions.length ? (totalAlerts / sessions.length).toFixed(2) : 0;
                document.getElementById('avgAlertsPerSession').textContent = avgAlertsPerSession;

                // Top 5 students by total alerts across sessions
                const studentAlertCounts = {};
                (sessions || []).forEach(s => {
                    const uid = s.user_id;
                    const count = Object.values(s.flags || {}).reduce((sum, arr) => sum + ((Array.isArray(arr) ? arr.length : 0)), 0);
                    if (!uid) return;
                    studentAlertCounts[uid] = (studentAlertCounts[uid] || 0) + count;
                });
                const topStudents = Object.entries(studentAlertCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([uid, count]) => {
                        const u = users.find(x => x.id === uid) || { name: uid };
                        return `<tr><td>${u.name}</td><td>${count}</td></tr>`;
                    }).join('');
                document.getElementById('topStudentsByAlerts').innerHTML = topStudents || '<tr><td colspan="2">No data</td></tr>';

                // Top 5 exams by alerts per session
                const examStats = {};
                (sessions || []).forEach(s => {
                    const eid = s.exam_id;
                    if (!eid) return;
                    const count = Object.values(s.flags || {}).reduce((sum, arr) => sum + ((Array.isArray(arr) ? arr.length : 0)), 0);
                    if (!examStats[eid]) examStats[eid] = { alerts: 0, sessions: 0 };
                    examStats[eid].alerts += count;
                    examStats[eid].sessions += 1;
                });
                const topExams = Object.entries(examStats)
                    .map(([eid, st]) => ({ eid, rate: st.alerts / Math.max(1, st.sessions) }))
                    .sort((a, b) => b.rate - a.rate)
                    .slice(0, 5)
                    .map(x => {
                        const ex = exams.find(e => e.id === x.eid) || { title: x.eid };
                        return `<tr><td>${ex.title}</td><td>${x.rate.toFixed(2)}</td></tr>`;
                    }).join('');
                document.getElementById('topExamsByAlertRate').innerHTML = topExams || '<tr><td colspan="2">No data</td></tr>';

                // (optional) Participation rate: users who appear in exam_results vs known students
                const resultUserIds = new Set((examResults || []).map(r => r.user_id).filter(Boolean));
                const participationRate = studentUsers.length ? Math.round((resultUserIds.size / studentUsers.length) * 100) : 0;
                // set a tooltip or reuse element (here we set 'totalStudents' title)
                document.getElementById('totalStudents').title = `Participation: ${participationRate}%`;

                // Load student scores with proctoring flags
                await loadStudentScoresWithFlags(users, exams, sessions, examResults);

                // done
            } catch (err) {
                console.error('Error loading dashboard data:', err);
            }
        }

        // Load data when page loads
        loadDashboardData();

        // Real-time data updates every 30 seconds
        setInterval(loadDashboardData, 30000);

        // Load student scores with proctoring flags
        async function loadStudentScoresWithFlags(users, exams, sessions, examResults) {
            try {
                const tbody = document.getElementById('studentScoresTable');
                tbody.innerHTML = '';

                // If no exam results, show message
                if (!examResults || examResults.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No exam results found. Students will appear here after they complete exams.</td></tr>';
                    return;
                }

                // Group results by student
                const studentResults = {};

                examResults.forEach(result => {
                    // Handle both user_id and student_id fields
                    const userId = result.user_id || result.student_id;
                    if (userId) {
                        if (!studentResults[userId]) {
                            studentResults[userId] = [];
                        }
                        studentResults[userId].push(result);
                    }
                });

                // Display results for each student
                Object.entries(studentResults).forEach(([userId, results]) => {
                    const student = users.find(u => u.id === userId);
                    
                    // Skip if student not found (might be deleted user)
                    if (!student) {
                        console.warn('Student not found for userId:', userId);
                        return;
                    }

                    results.forEach(result => {
                        const exam = exams.find(e => e.id === result.exam_id);

                        // Skip if exam not found
                        if (!exam) {
                            console.warn('Exam not found for exam_id:', result.exam_id);
                            return;
                        }

                        // Calculate score
                        let scoreDisplay = 'N/A';
                        if (exam.questions && result.answers) {
                            let correctAnswers = 0;
                            exam.questions.forEach((question, index) => {
                                if (result.answers && result.answers[index] === question.correctAnswer) {
                                    correctAnswers++;
                                }
                            });
                            scoreDisplay = `${correctAnswers}/${exam.questions.length}`;
                        }

                        // Get proctoring flags for this session
                        // Check both user_id and student_id for compatibility
                        const session = sessions.find(s => 
                            (s.user_id === userId || s.student_id === userId) && 
                            s.exam_id === result.exam_id
                        );
                        let flagsDisplay = 'None';

                        if (session && session.flags) {
                            let flagsObj = session.flags;
                            if (Array.isArray(flagsObj)) {
                                flagsObj = {};
                                flagsObj.forEach(f => Object.assign(flagsObj, f));
                            }
                            const flags = [];
                            Object.entries(flagsObj).forEach(([type, alerts]) => {
                                if (Array.isArray(alerts) && alerts.length > 0) {
                                    flags.push(`${type}: ${alerts.length}`);
                                }
                            });
                            if (flags.length > 0) {
                                flagsDisplay = flags.join(', ');
                            }
                        }

                        const row = `
                            <tr>
                                <td><strong>${student.name || 'Unknown'}</strong><br><small class="text-muted">${student.email || ''}</small></td>
                                <td>${exam.title || 'Unknown'}<br><small class="text-muted">${exam.subject || ''}</small></td>
                                <td><strong>${scoreDisplay}</strong></td>
                                <td>${result.timestamp ? new Date(result.timestamp).toLocaleDateString() : 'N/A'}</td>
                                <td><span class="badge ${flagsDisplay !== 'None' ? 'bg-warning' : 'bg-success'}">${flagsDisplay}</span></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                });
                
                // Sort by date taken (most recent first)
                if (tbody.children.length > 1) {
                    const rows = Array.from(tbody.children);
                    rows.sort((a, b) => {
                        const dateA = new Date(a.cells[3].textContent);
                        const dateB = new Date(b.cells[3].textContent);
                        return dateB - dateA; // Most recent first
                    });
                    // Clear and re-append sorted rows
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                }

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No exam results found</td></tr>';
                }

            } catch (err) {
                console.error('Error loading student scores:', err);
                document.getElementById('studentScoresTable').innerHTML =
                    '<tr><td colspan="5" class="text-center text-danger">Error loading scores</td></tr>';
            }
        }

        // Function to delete old reports (admin only)
        async function deleteOldReports() {
            const cutoffDays = document.getElementById('cutoffDays').value;
            const cutoffDate = document.getElementById('cutoffDate').value;

            let confirmMessage = 'Are you sure you want to delete all reports ';
            if (cutoffDate) {
                confirmMessage += `older than ${cutoffDate}?`;
            } else {
                confirmMessage += `older than ${cutoffDays} days?`;
            }
            confirmMessage += ' This action cannot be undone.';

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const btn = document.getElementById('deleteReportsBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Deleting...';
                btn.disabled = true;

                const requestBody = {};
                if (cutoffDate) {
                    requestBody.cutoff_date = cutoffDate + 'T00:00:00Z';
                } else {
                    requestBody.cutoff_days = parseInt(cutoffDays);
                }

                const response = await fetch('/delete_old_reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // Reload dashboard data
                    loadDashboardData();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete reports error:', error);
                alert('Failed to delete reports. Please try again.');
            } finally {
                const btn = document.getElementById('deleteReportsBtn');
                btn.innerHTML = '<i class="bx bx-trash"></i> Delete Old Reports';
                btn.disabled = false;
            }
        }

        // Function to clear date selection
        function clearDateSelection() {
            document.getElementById('cutoffDate').value = '';
        }

        // Function to delete ALL reports (admin only)
        async function deleteAllReports() {
            const confirmationText = prompt('Type "CONFIRM DELETION" to delete ALL reports permanently:');
            if (confirmationText !== 'CONFIRM DELETION') {
                alert('Deletion cancelled. You must type "CONFIRM DELETION" exactly.');
                return;
            }

            if (!confirm('⚠️ WARNING: This will delete ALL proctoring reports and associated files permanently. This action CANNOT be undone. Are you absolutely sure?')) {
                return;
            }

            try {
                const btn = document.getElementById('deleteAllBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Deleting...';
                btn.disabled = true;

                const response = await fetch('/delete_old_reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ delete_all: true })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // Reload dashboard data
                    loadDashboardData();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete all reports error:', error);
                alert('Failed to delete reports. Please try again.');
            } finally {
                const btn = document.getElementById('deleteAllBtn');
                btn.innerHTML = '<i class="bx bx-trash-alt"></i> Delete ALL Reports';
                btn.disabled = false;
            }
        }
    </script>

</body>

</html>
